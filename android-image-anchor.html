<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Test Hit-Test Minimal</title>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <style>
    body{margin:0;overflow:hidden;background:#000}
    #hud{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 10px;
         border-radius:8px;background:rgba(0,0,0,.55);color:#fff;z-index:10}
  </style>
</head>
<body>
  <div id="hud">Démarrer AR → vois-tu l’anneau ?</div>

  <a-scene id="scene" vr-mode-ui="enabled:false"
    webxr="requiredFeatures: hit-test,local; optionalFeatures: dom-overlay; overlayElement: body">

    <a-entity id="reticle" visible="false"
      geometry="primitive:ring;radiusInner:0.03;radiusOuter:0.05"
      material="shader:flat;color:#00ff00"
      rotation="-90 0 0"></a-entity>

    <a-entity id="box" geometry="primitive:box" material="color:red" visible="false"></a-entity>

    <a-camera look-controls="enabled:true"></a-camera>
  </a-scene>

  <script>
    const hud = document.getElementById('hud');
    const scene = document.getElementById('scene');
    const reticle = document.getElementById('reticle');
    const box = document.getElementById('box');

    let hitTestSource=null, refSpace=null;

    scene.addEventListener('enter-vr', async ()=>{
      hud.textContent="AR lancé, recherche de surface…";
      const session=scene.renderer.xr.getSession();
      const viewerSpace=await session.requestReferenceSpace('viewer');
      refSpace=await session.requestReferenceSpace('local');
      hitTestSource=await session.requestHitTestSource({space:viewerSpace});
    });

    scene.addEventListener('renderstart', ()=>{
      scene.renderer.setAnimationLoop((t,frame)=>{
        if (!frame || !hitTestSource || !refSpace) return;
        const results=frame.getHitTestResults(hitTestSource);
        if (results.length>0){
          const pose=results[0].getPose(refSpace);
          reticle.object3D.position.set(pose.transform.position.x,
                                        pose.transform.position.y,
                                        pose.transform.position.z);
          reticle.object3D.quaternion.set(pose.transform.orientation.x,
                                          pose.transform.orientation.y,
                                          pose.transform.orientation.z,
                                          pose.transform.orientation.w);
          reticle.setAttribute('visible',true);
          box.setAttribute('visible',true);
          box.object3D.position.copy(reticle.object3D.position);
          hud.textContent="Surface trouvée ✔";
        }
      });
    });
  </script>
</body>
</html>
